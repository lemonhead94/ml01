---
output:
  bookdown::pdf_document2:
    includes:
      in_header: latex/preamble.tex
      before_body: latex/titlepage.tex
    pandoc_args:
    - --csl
    - references/apa.csl
  bookdown::html_document2:
    pandoc_args:
    - --csl
    - references/apa.csl
  bookdown::word_document2:
    pandoc_args:
    - --csl
    - references/apa.csl
toc-title: Table of Contents
bibliography: references/references.bib
link-citations: yes
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \renewcommand{\headrulewidth}{0pt}
- \fancyfoot[C]{}
- \fancyfoot[R]{\thepage}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE)
packages <- c("bookdown", "dplyr", "ggplot2", "papeR", "kableExtra", "mgcv", "caret", "vip", "rsample", "tidyverse", "yardstick", "arm", "pROC")
package.check <- lapply(packages, FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
        install.packages(x, dependencies = TRUE)
        library(x, character.only = TRUE)
    }
})
```

```{=tex}
\fancyhead[LR]{}
\pagenumbering{roman}
```
```{=tex}
\newpage
\cleardoublepage
\pagenumbering{arabic}
\fancyhead[L]{Employee Attrition Model}
\fancyhead[R]{Machine Learning I}
```
# Introduction

Employees, according to @IBM_Developer_Challenge_2020, are the foundation of any business. Its success is largely determined by the quality of its employees and their ability to stay with the company. Organizations confront a number of issues as a result of staff attrition:

1.  Training new personnel is costly in terms of both money and time.
2.  Potential to lose experienced employees
3.  Productivity impact
4.  Profitability impact

Therefore, IBM data scientists created a fictitious data set as a challenge for data scientists. Among the data types are metrics such as education level, job satisfaction, and commute distance. The dataset can be found on the company's GitHub account [@IBM_Data_2019].

# Methodology

The following topics are layed out through out this paper:

1.  Linear Models
2.  Extending the Linear Model: Non-linearity (GAM)
3.  Extending the Linear Model: Generalised Linear Models (GLM)
- poisson as well as binominal
4.  Support Vector Machines
5.  Neural Networks
6.  Optimisation

\newpage

# Data preparation

```{r import-data, echo = FALSE, results = FALSE}
emp_attrition <- read.csv("./data/emp_attrition.csv")
head(emp_attrition)
```

## Data Transformation and Sanity Check

The code for this part is left out from the PDF due to its length...

```{r formatting-data, echo = FALSE, results = FALSE}
# Age
summary(emp_attrition$Age)

# Attrition
emp_attrition$Attrition <- as.factor(emp_attrition$Attrition)
unique(emp_attrition$Attrition)

# BusinessTravel
emp_attrition$BusinessTravel <- as.factor(emp_attrition$BusinessTravel)
levels(emp_attrition$BusinessTravel) <- c("Rarely", "Frequently", "None")
emp_attrition$BusinessTravel <- relevel(emp_attrition$BusinessTravel, ref = "None")
unique(emp_attrition$BusinessTravel)

# DailyRate
summary(emp_attrition$DailyRate)

# Department
emp_attrition$Department <- as.factor(emp_attrition$Department)
levels(emp_attrition$Department) <- c("Sales", "R&D", "HR")
unique(emp_attrition$Department)

# DistanceFromHome
summary(emp_attrition$DistanceFromHome)

# Education
emp_attrition$Education <- as.factor(emp_attrition$Education)
levels(emp_attrition$Education) <- c("Below College", "College", "Bachelor", "Master", "Doctor")
unique(emp_attrition$Education)

# EducationField
emp_attrition$EducationField <- as.factor(emp_attrition$EducationField)
unique(emp_attrition$EducationField)

# EmployeeCount
unique(emp_attrition$EmployeeCount) # represents headcount which for all employee's in this dataset 1

# EmployeeNumber
summary(emp_attrition$EmployeeNumber) # internal employee id

# EnvironmentSatisfaction
emp_attrition$EnvironmentSatisfaction <- as.factor(emp_attrition$EnvironmentSatisfaction)
levels(emp_attrition$EnvironmentSatisfaction) <- c("Low", "Medium", "High", "Very High")
unique(emp_attrition$EnvironmentSatisfaction)

# Gender
emp_attrition$Gender <- as.factor(emp_attrition$Gender)
unique(emp_attrition$Gender)

# HourlyRate
summary(emp_attrition$HourlyRate)

# JobInvolvement
emp_attrition$JobInvolvement <- as.factor(emp_attrition$JobInvolvement)
levels(emp_attrition$JobInvolvement) <- c("Low", "Medium", "High", "Very High")
unique(emp_attrition$JobInvolvement)

# JobLevel
emp_attrition$JobLevel <- as.factor(emp_attrition$JobLevel)
unique(emp_attrition$JobLevel)

# JobRole
emp_attrition$JobRole <- as.factor(emp_attrition$JobRole)
unique(emp_attrition$JobRole)

# JobSatisfaction
emp_attrition$JobSatisfaction <- as.factor(emp_attrition$JobSatisfaction)
levels(emp_attrition$JobSatisfaction) <- c("Low", "Medium", "High", "Very High")
unique(emp_attrition$JobSatisfaction)

# MaritalStatus
emp_attrition$MaritalStatus <- as.factor(emp_attrition$MaritalStatus)
unique(emp_attrition$MaritalStatus)

# MonthlyIncome
summary(emp_attrition$MonthlyIncome)

# MonthlyRate
summary(emp_attrition$MonthlyRate)

# NumCompaniesWorked
unique(emp_attrition$NumCompaniesWorked)

# Over18
unique(emp_attrition$Over18) # all employee's are above 18

# OverTime
emp_attrition$OverTime <- as.factor(emp_attrition$OverTime)
unique(emp_attrition$OverTime)

# PercentSalaryHike
summary(emp_attrition$PercentSalaryHike)

# PerformanceRating
emp_attrition$PerformanceRating <- as.factor(emp_attrition$PerformanceRating)
levels(emp_attrition$PerformanceRating) <- c("Excellent", "Outstanding")
unique(emp_attrition$PerformanceRating) # only employee's who perform 3 or 4

# RelationshipSatisfaction
emp_attrition$RelationshipSatisfaction <- as.factor(emp_attrition$RelationshipSatisfaction)
levels(emp_attrition$RelationshipSatisfaction) <- c("Low", "Medium", "High", "Very High")
unique(emp_attrition$RelationshipSatisfaction)

# StandardHours
unique(emp_attrition$StandardHours) # the StandardHours for all employee's is 80, after check this means that this data has a 9/80 work schedule. Hence, employees work 80 hours in 9 days. So not a standard as 5/42 as in switzerland..

# StockOptionLevel
emp_attrition$StockOptionLevel <- as.factor(emp_attrition$StockOptionLevel)
unique(emp_attrition$StockOptionLevel)

# TotalWorkingYears
summary(emp_attrition$TotalWorkingYears)

# TrainingTimesLastYear
unique(emp_attrition$TrainingTimesLastYear)

# WorkLifeBalance
emp_attrition$WorkLifeBalance <- as.factor(emp_attrition$WorkLifeBalance)
levels(emp_attrition$WorkLifeBalance) <- c("Bad", "Good", "Better", "Best")
unique(emp_attrition$WorkLifeBalance)

# YearsAtCompany
summary(emp_attrition$YearsAtCompany)

# YearsInCurrentRole
summary(emp_attrition$YearsInCurrentRole)

# YearsSinceLastPromotion
summary(emp_attrition$YearsSinceLastPromotion)

# YearsWithCurrManager
summary(emp_attrition$YearsWithCurrManager)

labels(emp_attrition) <- colnames(emp_attrition)
labels(emp_attrition, which = c("Age", "BusinessTravel", "DailyRate", "DistanceFromHome", "EducationField", "EmployeeNumber", "EnvironmentSatisfaction", "HourlyRate", "JobInvolvement", "JobLevel", "JobRole", "JobSatisfaction", "MaritalStatus", "MonthlyIncome", "MonthlyRate", "NumCompaniesWorked", "OverTime", "PercentSalaryHike", "PerformanceRating", "RelationshipSatisfaction", "StockOptionLevel", "TotalWorkingYears", "TrainingTimesLastYear", "WorkLifeBalance", "YearsAtCompany", "YearsInCurrentRole", "YearsSinceLastPromotion", "YearsWithCurrManager")) <- c("Age (years)", "Business Travel", "Daily Rate (salary per day)", "Distance From Home (1-29)", "Education Field", "Employee ID", "Environment Satisfaction", "Hourly Rate (salary per hour)", "Job Involvement", "Job Level (internal company hierachy 1-5)", "Job Role", "Job Satisfaction", "Marital Status", "Monthly Income", "Monthly Rate (salary per month)", "Number of Companies worked before starting this position", "has done over time", "% Salary Hike", "Performance Rating", "Relationship Satisfaction", "Stock Option Level (number of stocks an employee owns from 0-3)", "Total Working Years", "Number Of Trainings Done Last Year", "Work Life Balance", "Number Of Years At Company", "Number of Years In Current Role", "Number Of Years Since Last Promotion", "Number Of Years With Current Manager")
```

## Data Cleaning

```{r data-cleaning}
emp_attrition <- emp_attrition %>% dplyr::select(-c(EmployeeCount, StandardHours, Over18))
```

-   EmployeeCount (represents the head count which is 1 for all employee, hence drop this)
-   StandardHours (StandardHours for all employee's is 80, therefore this data has a 9/80 work schedule. Hence, employees work 80 hours in 9 days. So not a standard as 5/42 as in switzerland, we drop this)
-   Over18 (all employee's are 18 or above and it's capured in age, hence drop this variable)

## Missing Value Check

```{r check-for-missing-values, echo = TRUE, results = FALSE}
# Do we have any missing values?
sapply(emp_attrition, function(x) all(is.na(x) | x == '' ))
```

There are no missing values in this dataset.

\newpage

## Overview of Dataset

```{r numeric-variable-table, echo = FALSE, message = FALSE, results='asis'}
kable(summarize(emp_attrition, type = "numeric"), 
      caption = "Summary Numeric Variables", format = "latex", booktabs = TRUE) %>%
  kable_styling(latex_options = "hold_position")
```

```{r factor-variable-table, echo = FALSE, message = FALSE, results='asis'}
summary.factors <- papeR::summarize(emp_attrition, type = "factor")
kable(list(summary.factors[1:33,], summary.factors[34:66,]), 
      caption = "Summary Factor Variables", format = "latex", booktabs = TRUE, row.names = FALSE) %>%
  kable_styling(latex_options = "hold_position", font_size = 5.8)
```

\newpage

# Exploration

\newpage

# Linear Regression

# Extending the Linear Model

## Generalised Linear Models

### Simple Logistic Regression

```{r}
attrition_model1 <- glm(Attrition ~ OverTime, family = "binomial", data = emp_attrition)
summary(attrition_model1)
```
Not unexpectedly overtime seems to play a relevant role. Indeed, its p-value is highly significant.

```{r, out.width = "50%"}
ggplot(emp_attrition, aes(OverTime, attrition_model1$fitted.values, color = OverTime)) +
  geom_boxplot(show.legend = FALSE) +
  geom_rug(sides = "b", position = "jitter", alpha = 0.2, show.legend = FALSE) +
  labs(title="Attrition ~ OverTime", x="OverTime", y="Probability of Attrition")
```

```{r}
exp(coef(attrition_model1)["OverTimeYes"])
```

The odds of someone leaving the company with overtime are about ~3.8 times higher than the odds for no overtime.
Now, this seems quite important!



### Best Model

```{r}
prop.table(table(emp_attrition$Attrition))
```

There is significant class imbalance in the variable Attrition, which makes sense since most employees want to work at the company not quite working there.
However it is important to stratify the train and test split so that we receive a more realist estimate on how our model is going to perform.

```{r, echo=TRUE, message=FALSE, warning=FALSE }
# Create training (80%) and test (20%)
set.seed(111)
emp_attrition_split <- initial_split(emp_attrition, prop = 0.80, strata = "Attrition")

emp_attrition_train <- training(emp_attrition_split)
# count(emp_attrition_train %>% filter(emp_attrition_train$Attrition == "Yes")) # 189
# count(emp_attrition_train %>% filter(emp_attrition_train$Attrition == "No")) # 986
# i.e. 986 / 189 = 5.22
emp_attrition_test  <- testing(emp_attrition_split)
# count(emp_attrition_test %>% filter(emp_attrition_test$Attrition == "Yes")) # 48
# count(emp_attrition_test %>% filter(emp_attrition_test$Attrition == "No")) # 248
# i.e. 248 / 48 = 5.17
```

As can be observed above we have an almost equal ratio of yes to no in the training as well as the testing data set due to stratification.

```{r, echo=TRUE, message=FALSE, warning=FALSE }
glm.model <- glm(Attrition ~ ., family = "binomial", data = emp_attrition_train)
vip(glm.model, num_features = 30)
```

In the above plot we can observe the most important variables (Variable Importance) to predict employment attrition according to the absolute value of the t-statistic. We observe that OverTime seems to be highly correlated with Attrition in this data set. Moreover, EnviromentSatisfaction and JobSatisfaction seem to also be critical, which would make sense since we are talking about employment attrititon.

```{r}
glm.model.2 <- glm(Attrition ~ EnvironmentSatisfaction + NumCompaniesWorked + 
                     JobSatisfaction + BusinessTravel + DistanceFromHome + 
                     OverTime + WorkLifeBalance + Age + YearsWithCurrManager + 
                     YearsSinceLastPromotion, 
                   family = "binomial", data = emp_attrition_train)
summary(glm.model.2)
vip(glm.model.2, num_features = 30)
```

Based on the previous EDA and the conclusions of the linear model we may also fit a simpler model.
By reducing the number of predictors we also get a different variable importance score.
However, Age seems to have ranked a lot higher than before and overtime is still seems to show a large main effect.
Therefore, we should check the interaction of these as well.

```{r}
glm.model.2 <- glm(Attrition ~ EnvironmentSatisfaction + NumCompaniesWorked + 
                     JobSatisfaction + BusinessTravel + DistanceFromHome + 
                     WorkLifeBalance + YearsWithCurrManager + 
                     YearsSinceLastPromotion + Age + OverTime, 
                   family = "binomial", data = emp_attrition_train)
summary(glm.model.2)
vip(glm.model.2, num_features = 30)
```

### Model Development

```{r, echo=FALSE, results=FALSE}
glm.model.2 <- glm(Attrition ~ EnvironmentSatisfaction + NumCompaniesWorked + 
                     JobSatisfaction + BusinessTravel + DistanceFromHome + 
                     WorkLifeBalance + YearsWithCurrManager + 
                     YearsSinceLastPromotion + Age + OverTime +
                     # interactions of Age
                     Age:EnvironmentSatisfaction +
                     Age:NumCompaniesWorked +
                     Age:JobSatisfaction +
                     Age:BusinessTravel +
                     Age:DistanceFromHome +
                     Age:WorkLifeBalance +
                     Age:YearsWithCurrManager +
                     Age:YearsSinceLastPromotion +
                     Age:OverTime, 
                   family = "binomial", data = emp_attrition_train)

drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ . - EnvironmentSatisfaction:Age - NumCompaniesWorked:Age - DistanceFromHome:Age - WorkLifeBalance:Age - YearsSinceLastPromotion:Age)

glm.model.2 <- update(glm.model.2, . ~ . + OverTime:EnvironmentSatisfaction +
                     OverTime:NumCompaniesWorked +
                     OverTime:JobSatisfaction +
                     OverTime:BusinessTravel +
                     OverTime:DistanceFromHome +
                     OverTime:WorkLifeBalance +
                     OverTime:YearsWithCurrManager +
                     OverTime:YearsSinceLastPromotion)

drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ . - OverTime:EnvironmentSatisfaction
                     - OverTime:NumCompaniesWorked
                     - OverTime:JobSatisfaction
                     - OverTime:BusinessTravel
                     - OverTime:DistanceFromHome
                     - OverTime:WorkLifeBalance
                     - OverTime:YearsWithCurrManager
                     - OverTime:YearsSinceLastPromotion
                     - OverTime:Age
                     - BusinessTravel:Age)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + EnvironmentSatisfaction:NumCompaniesWorked
                     + EnvironmentSatisfaction:JobSatisfaction
                     + EnvironmentSatisfaction:BusinessTravel
                     + EnvironmentSatisfaction:DistanceFromHome
                     + EnvironmentSatisfaction:WorkLifeBalance
                     + EnvironmentSatisfaction:YearsWithCurrManager
                     + EnvironmentSatisfaction:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - EnvironmentSatisfaction:NumCompaniesWorked
                     - EnvironmentSatisfaction:JobSatisfaction
                     - EnvironmentSatisfaction:BusinessTravel
                     - EnvironmentSatisfaction:DistanceFromHome
                     - EnvironmentSatisfaction:WorkLifeBalance
                     - EnvironmentSatisfaction:YearsWithCurrManager
                     - EnvironmentSatisfaction:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + NumCompaniesWorked:NumCompaniesWorked
                     + NumCompaniesWorked:JobSatisfaction
                     + NumCompaniesWorked:BusinessTravel
                     + NumCompaniesWorked:DistanceFromHome
                     + NumCompaniesWorked:WorkLifeBalance
                     + NumCompaniesWorked:YearsWithCurrManager
                     + NumCompaniesWorked:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - NumCompaniesWorked:NumCompaniesWorked
                     - NumCompaniesWorked:JobSatisfaction
                     - NumCompaniesWorked:BusinessTravel
                     - NumCompaniesWorked:DistanceFromHome
                     - NumCompaniesWorked:WorkLifeBalance
                     - NumCompaniesWorked:YearsWithCurrManager
                     - NumCompaniesWorked:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + JobSatisfaction:NumCompaniesWorked
                     + JobSatisfaction:JobSatisfaction
                     + JobSatisfaction:BusinessTravel
                     + JobSatisfaction:DistanceFromHome
                     + JobSatisfaction:WorkLifeBalance
                     + JobSatisfaction:YearsWithCurrManager
                     + JobSatisfaction:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - JobSatisfaction:BusinessTravel
                     - JobSatisfaction:DistanceFromHome
                     - JobSatisfaction:YearsWithCurrManager
                     - JobSatisfaction:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + BusinessTravel:NumCompaniesWorked
                     + BusinessTravel:JobSatisfaction
                     + BusinessTravel:DistanceFromHome
                     + BusinessTravel:WorkLifeBalance
                     + BusinessTravel:YearsWithCurrManager
                     + BusinessTravel:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - BusinessTravel:NumCompaniesWorked
                     - BusinessTravel:DistanceFromHome
                     - BusinessTravel:WorkLifeBalance
                     - BusinessTravel:YearsWithCurrManager
                     - BusinessTravel:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + DistanceFromHome:NumCompaniesWorked
                     + DistanceFromHome:JobSatisfaction
                     + DistanceFromHome:BusinessTravel
                     + DistanceFromHome:WorkLifeBalance
                     + DistanceFromHome:YearsWithCurrManager
                     + DistanceFromHome:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - DistanceFromHome:NumCompaniesWorked
                     - DistanceFromHome:JobSatisfaction
                     - DistanceFromHome:BusinessTravel
                     - DistanceFromHome:WorkLifeBalance
                     - DistanceFromHome:YearsWithCurrManager
                     - DistanceFromHome:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + WorkLifeBalance:NumCompaniesWorked
                     + WorkLifeBalance:JobSatisfaction
                     + WorkLifeBalance:BusinessTravel
                     + WorkLifeBalance:YearsWithCurrManager
                     + WorkLifeBalance:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - WorkLifeBalance:NumCompaniesWorked
                     - WorkLifeBalance:BusinessTravel
                     - WorkLifeBalance:YearsWithCurrManager
                     - WorkLifeBalance:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + YearsWithCurrManager:NumCompaniesWorked
                     + YearsWithCurrManager:JobSatisfaction
                     + YearsWithCurrManager:BusinessTravel
                     + YearsWithCurrManager:YearsSinceLastPromotion)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - YearsWithCurrManager:NumCompaniesWorked
                     - YearsWithCurrManager:JobSatisfaction
                     - YearsWithCurrManager:BusinessTravel)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     + YearsSinceLastPromotion:NumCompaniesWorked
                     + YearsSinceLastPromotion:JobSatisfaction
                     + YearsSinceLastPromotion:BusinessTravel
                     + YearsSinceLastPromotion:DistanceFromHome
                     + YearsSinceLastPromotion:WorkLifeBalance
                     + YearsSinceLastPromotion:YearsWithCurrManager)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ .
                     - YearsSinceLastPromotion:NumCompaniesWorked
                     - YearsSinceLastPromotion:JobSatisfaction
                     - YearsSinceLastPromotion:BusinessTravel
                     - YearsSinceLastPromotion:DistanceFromHome
                     - YearsSinceLastPromotion:WorkLifeBalance
                     - YearsSinceLastPromotion:YearsWithCurrManager)
drop1(glm.model.2, test = "F")

glm.model.2 <- update(glm.model.2, . ~ . - Age:YearsWithCurrManager)
drop1(glm.model.2, test = "F")
```
By using the drop1 function we have added and remove significant interactions.
Finally we end up with significant interaction inclusion of JobSatifaction with Age, Number of Comapnies Worked for, Work Life Balance and Business Travel Frequency.


### Confusion Matrix

```{r confusion-matrix, echo=FALSE, message=FALSE, warning=FALSE, out.width = "33%"}
set.seed(123)
cv_glm.model <- train(
  Attrition ~ ., 
  data = emp_attrition_train, 
  method = "glm",
  family = "binomial",
  trControl = trainControl(method = "cv", number = 10) # 10 fold cross validation
)

emp_attrition_results <- emp_attrition_test %>%
        mutate(`Logistic regression` = predict(cv_glm.model, emp_attrition_test))

# confusion matrix
conf_mat(emp_attrition_results, truth = Attrition, estimate = `Logistic regression`) %>% 
  autoplot(type = "heatmap")

cv_glm.model.2 <- train(
  Attrition ~ EnvironmentSatisfaction + NumCompaniesWorked + JobSatisfaction + 
    BusinessTravel + DistanceFromHome + OverTime + YearsAtCompany + 
    PercentSalaryHike + WorkLifeBalance + Age + YearsWithCurrManager + 
    YearsSinceLastPromotion, 
  data = emp_attrition_train, 
  method = "glm",
  family = "binomial",
  trControl = trainControl(method = "cv", number = 10) # 10 fold cross validation
)

emp_attrition_results.2 <- emp_attrition_test %>%
        mutate(`Logistic regression` = predict(cv_glm.model.2, emp_attrition_test))

# confusion matrix
conf_mat(emp_attrition_results.2, truth = Attrition, estimate = `Logistic regression`) %>% 
  autoplot(type = "heatmap")

cv_glm.model.3 <- train(
  Attrition ~ EnvironmentSatisfaction + NumCompaniesWorked + JobSatisfaction + 
    BusinessTravel + DistanceFromHome + OverTime + YearsAtCompany + 
    PercentSalaryHike + WorkLifeBalance + Age + YearsWithCurrManager + 
    YearsSinceLastPromotion + 
    JobSatisfaction:Age + JobSatisfaction:NumCompaniesWorked + 
    JobSatisfaction:WorkLifeBalance + JobSatisfaction:BusinessTravel, 
  data = emp_attrition_train, 
  method = "glm",
  family = "binomial",
  trControl = trainControl(method = "cv", number = 10) # 10 fold cross validation
)

emp_attrition_results.3 <- emp_attrition_test %>%
        mutate(`Logistic regression` = predict(cv_glm.model.3, emp_attrition_test))

# confusion matrix
conf_mat(emp_attrition_results.3, truth = Attrition, estimate = `Logistic regression`) %>% 
  autoplot(type = "heatmap")
```
**Interpretation**

1. When looking at the first plot using cross validation & including all predictors we get the following scores.

**Specificity** = True Negatives / (True Negatives + False Positives)

- i.e. 237 / (10 + 237) = 0.95
- 95% of the people not leaving the company were correctly identified by the Logistic Regression model.


**Sensitivity** = True Positives / (True Positives + False Negatives)

- i.e. 19 / (29 + 19) = 0.4
- 40% of the people leaving the company were correctly identified by the Logistic Regression model.

2. Without interactions using a much simpler model we actually get a better specificity, but can only predict 23% of the people who are actually leaving the company. In other words the True Positive Rate which we are looking for is significantly worse.

**Specificity** = 239 / (8 + 239) = 0.97
- 97% of the people not leaving the company were correctly identified by the Logistic Regression model.

**Sensitivity** = 11 / (37 + 11) = 0.23
- 23% of the people leaving the company were correctly identified by the Logistic Regression model.

3. When including the interactions we are able to predict the True Positive Rate a bit better however we sacrifice some of the specificity

**Specificity** = 235 / (12 + 235) = 0.95
- 95% of the people not leaving the company were correctly identified by the Logistic Regression model.

**Sensitivity** = 12 / (36 + 12) = 0.25
- 25% of the people leaving the company were correctly identified by the Logistic Regression model.


```{r roc, echo=TRUE, message=FALSE, warning=FALSE, results='hide',fig.keep='all'}
set.seed(123)
cv_glm.probability <- predict(cv_glm.model, emp_attrition_train, type = "prob")$Yes
roc.info <- roc(emp_attrition_train$Attrition, cv_glm.probability, legacy.axes=TRUE)
roc.df <- data.frame(tpp=roc.info$sensitivities*100, 
                     fpp=(1-roc.info$specificities)*100,
                     thresholds=roc.info$thresholds)

# determining the perfect cutoff
# roc.df[roc.df$tpp > 78 & roc.df$tpp < 79, ]
# emp_attrition_train_2 <- emp_attrition_train %>% mutate(prob = ifelse(Attrition == "Yes", 1, 0))
# emp_attrition_train_2 <- broom::augment(glm.model, emp_attrition_train_2) %>% mutate(.fitted = exp(.fitted))
# confusionMatrix(as.factor(ifelse(emp_attrition_train_2$.fitted >= .78, "Yes", "No")), emp_attrition_train_2$Attrition)$table

# plotting ROC
cv_glm.probability.3 <- predict(cv_glm.model.3, emp_attrition_train, type = "prob")$Yes
par(pty = "s")
roc(emp_attrition_train$Attrition, cv_glm.probability, plot=TRUE, legacy.axes=TRUE, percent=TRUE, xlab="False Positive Percentage", ylab="True Positive Percentage", col="blue", lwd=1, print.auc=TRUE)
plot.roc(emp_attrition_train$Attrition, cv_glm.probability.3, percent=TRUE, col="#4daf4a", add=TRUE, print.auc=TRUE, print.auc.y=40)
legend("bottomright", legend=c("All Predictors", "Model Development"), col = c("blue", "#4daf4a"), lwd=2)
```

### Cross Validation

```{r}
set.seed(123)
cv_glm.model.3.pls <- train(
  Attrition ~ EnvironmentSatisfaction + NumCompaniesWorked + JobSatisfaction + 
    BusinessTravel + DistanceFromHome + OverTime + YearsAtCompany + 
    PercentSalaryHike + WorkLifeBalance + Age + YearsWithCurrManager + 
    YearsSinceLastPromotion + 
    JobSatisfaction:Age + JobSatisfaction:NumCompaniesWorked + 
    JobSatisfaction:WorkLifeBalance + JobSatisfaction:BusinessTravel, 
  data = emp_attrition_train, 
  method = "pls",
  family = "binomial",
  trControl = trainControl(method = "cv", number = 10), # 10 fold cross validation
  preProcess = c("zv", "center", "scale"),
  tuneLength = 16
)
cv_glm.model.3.pls
# Model with lowest RMSE
ggplot(cv_glm.model.3.pls)
```


As can be observed in the plot above the model with lowest Root Mean Square Error (RMSE)

- 10 fold cross validaiton (90% of the data are used to train the model and 10% to test it).



\newpage

# Conclusion

\newpage

# Session Information {.unnumbered}

```{r session-info}
sessionInfo()
```

\newpage

# References
